# ประวัติการตรวจสอบ / Audit History

**คู่มือนี้เหมาะสำหรับ**: Admin ที่ต้องการติดตามการเปลี่ยนแปลงและตรวจสอบระบบ

---

## Audit Logging คืออะไร? / What is Audit Logging?

**ความหมาย**: การบันทึกทุกการกระทำที่สำคัญในระบบ

**วัตถุประสงค์**:
- 📝 **ความโปร่งใส** - รู้ว่าใครทำอะไร เมื่อไหร่
- 🔍 **ตรวจสอบ** - สืบย้อนหาสาเหตุของปัญหา
- 🔒 **ความปลอดภัย** - ป้องกันการเปลี่ยนแปลงที่ไม่ได้รับอนุญาต
- 📊 **วิเคราะห์** - ดูพฤติกรรมการใช้งาน

---

## สิ่งที่บันทึก / What is Logged?

### Appointment History / ประวัติการเปลี่ยนแปลงนัดหมาย

ทุกนัดหมายมีประวัติการเปลี่ยนแปลง เก็บใน **AppointmentHistory table**

**Actions ที่บันทึก**:
1. **CREATED** - สร้างนัดหมาย
2. **ASSIGNED** - มอบหมายให้เจ้าหน้าที่
3. **REASSIGNED** - เปลี่ยนเจ้าหน้าที่
4. **STATUS_CHANGED** - เปลี่ยนสถานะ (PENDING → CONFIRMED → COMPLETED)
5. **CANCELLED** - ยกเลิกนัดหมาย
6. **UPDATED** - แก้ไขข้อมูล (เวลา, รายละเอียด)

**ข้อมูลที่บันทึกต่อ Action**:
- **เวลา** (timestamp) - วันที่และเวลาที่เกิดเหตุการณ์
- **Action** - ชนิดของการกระทำ
- **ผู้ดำเนินการ** (performedBy) - เจ้าหน้าที่ที่ทำ (ถ้ามี)
- **เจ้าหน้าที่ที่เกี่ยวข้อง** (assignedStaff) - เจ้าหน้าที่ที่ถูก assign (ถ้ามี)
- **สถานะเก่า** (oldStatus) - สถานะก่อนเปลี่ยน
- **สถานะใหม่** (newStatus) - สถานะหลังเปลี่ยน

---

## ตัวอย่าง Audit Trail / Example Audit Trail

**นัดหมาย**: สมชาย ใจดี - ซ่อมคอมพิวเตอร์

```
[2026-02-04 10:15:30] CREATED
   By: Customer (สมชาย ใจดี)
   Status: → PENDING

[2026-02-04 10:20:15] ASSIGNED
   By: Admin (admin@prachin.go.th)
   Assigned to: สมหญิง (staff1@prachin.go.th)
   Status: PENDING → CONFIRMED

[2026-02-05 09:00:00] STATUS_CHANGED
   By: สมหญิง (staff1@prachin.go.th)
   Status: CONFIRMED → COMPLETED

```

**การตีความ**:
1. ลูกค้าสร้างนัดหมาย → สถานะ PENDING
2. Admin มอบหมายให้ สมหญิง → สถานะ CONFIRMED
3. สมหญิง ทำงานเสร็จ → สถานะ COMPLETED

---

## การดู Audit Log / Viewing Audit Logs

### ที่ระดับนัดหมาย / Appointment Level

**วิธีดู**:
1. ไปแท็บ **Appointments**
2. คลิกที่นัดหมาย
3. ในDialog → คลิก **"View History"** (ถ้ามี)
4. แสดงรายการ Action ทั้งหมดของนัดหมายนี้

**ตัวอย่างการแสดงผล**:
```
History for Appointment #A1234567

┌─────────────────┬──────────┬──────────────┬────────────┐
│ Timestamp       │ Action   │ By           │ Details    │
├─────────────────┼──────────┼──────────────┼────────────┤
│ 2026-02-04 10:15│ CREATED  │ Customer     │ PENDING    │
│ 2026-02-04 10:20│ ASSIGNED │ Admin        │ → สมหญิง  │
│ 2026-02-05 09:00│ COMPLETED│ สมหญิง       │ Done       │
└─────────────────┴──────────┴──────────────┴────────────┘
```

---

### ที่ระดับระบบ / System Level (Future Feature)

**หน้า Audit Logs** (อาจเพิ่มในอนาคต):
- แสดง Audit Log ทั้งหมดของระบบ
- กรองตาม: วันที่, Action, เจ้าหน้าที่
- ค้นหาตาม: Reference Number, ชื่อลูกค้า

---

## Use Cases / กรณีการใช้งาน

### 1. ตรวจสอบว่าใครยกเลิกนัดหมาย

**สถานการณ์**: ลูกค้าโทรมาถามว่าทำไมนัดหมายถูกยกเลิก

**ขั้นตอน**:
1. ค้นหานัดหมายตาม Reference Number
2. ดู Audit Log
3. ดู Action = CANCELLED
   - ถ้า By = Admin → Admin ยกเลิก (ถามAdmin ว่าทำไม)
   - ถ้า By = Staff → Staff ยกเลิก (ถามStaff ว่าทำไม)
   - ถ้า By = Customer → ลูกค้ายกเลิกเอง (แจ้งลูกค้า)

---

### 2. สืบย้อนการ Reassign

**สถานการณ์**: เจ้าหน้าที่โทรมาถามว่าทำไมงานถูก reassign

**ขั้นตอน**:
1. ค้นหานัดหมาย
2. ดู Audit Log
3. ดู Action = REASSIGNED
   - เวลา: เมื่อไหร่
   - By: Admin คนไหน
   - From: เจ้าหน้าที่เดิม
   - To: เจ้าหน้าที่ใหม่

**ตัวอย่าง**:
```
[2026-02-04 14:30] REASSIGNED
   By: Admin (admin@prachin.go.th)
   From: สมชาย (staff2@prachin.go.th)
   To: สมหญิง (staff1@prachin.go.th)
   Reason: สมชาย มีงานเยอะเกินไป
```

---

### 3. ตรวจสอบเวลาที่นัดหมายเปลี่ยนสถานะ

**สถานการณ์**: ต้องการรู้ว่านัดหมายเสร็จเมื่อไหร่

**ขั้นตอน**:
1. ดู Audit Log
2. ดู Action = STATUS_CHANGED, newStatus = COMPLETED
3. ดู Timestamp

---

## ความปลอดภัยและการปฏิบัติตาม / Security and Compliance

### การป้องกัน / Protection

**Audit Log ไม่สามารถ**:
- ❌ **แก้ไขได้** - เมื่อบันทึกแล้ว ไม่สามารถเปลี่ยนแปลง
- ❌ **ลบได้** (โดยทั่วไป) - เก็บไว้ตลอด
- ✅ **ดูได้เฉพาะ Admin** - เจ้าหน้าที่ทั่วไปไม่เห็น

---

### การปฏิบัติตามกฎหมาย / Compliance

**ประโยชน์**:
- 📋 **ตรวจสอบย้อนหลัง** - สืบสวนกรณีมีปัญหา
- 🔒 **ความปลอดภัย** - ตรวจจับการเข้าถึงที่ไม่ได้รับอนุญาต
- 📊 **รายงาน** - สรุปกิจกรรมในระบบ

---

## Data Retention / การเก็บข้อมูล

**ระยะเวลาเก็บ**: **อย่างน้อย 1 ปี**

**หลังจากนั้น**:
- Anonymize (ลบข้อมูลส่วนบุคคล, เก็บเฉพาะสถิติ)
- หรือลบ (ขึ้นอยู่กับนโยบาย)

---

## Best Practices / แนวทางที่ดี

### ✅ ตรวจสอบ Audit Log เมื่อมีปัญหา

- ลูกค้าร้องเรียน → เช็ค Audit Log ก่อน
- เจ้าหน้าที่สงสัย → ดู History

### ✅ ใช้ Audit Log วิเคราะห์พฤติกรรม

- ดูว่า Action ไหนเกิดบ่อย
- ถ้า REASSIGNED เยอะ → หาสาเหตุ (ทีมไม่สมดุล? assign ผิด?)

### ✅ อย่าแก้ไข Audit Log

- Audit Log เป็นข้อมูลสำคัญ
- ต้องเก็บไว้เป็นหลักฐาน

---

## ตัวอย่าง Use Case / Example Scenarios

### สถานการณ์ 1: นัดหมายหาย

**ปัญหา**: ลูกค้าโทรมาว่านัดหมายหาย

**ขั้นตอน**:
1. ค้นหานัดหมายตาม Reference Number
2. ถ้าหาไม่เจอ → เช็ค Audit Log
3. ดู Action = CANCELLED
   - ถ้ามี → นัดหมายถูกยกเลิก
   - By: ใครยกเลิก
   - Timestamp: เมื่อไหร่
4. แจ้งลูกค้า

---

### สถานการณ์ 2: ตรวจสอบความปลอดภัย

**ปัญหา**: สงสัยว่ามีคนเข้าถึงระบบโดยไม่ได้รับอนุญาต

**ขั้นตอน**:
1. ดู System Audit Log (future feature)
2. กรองตาม Action = LOGIN, LOGOUT
3. เช็คว่ามีการ Login ผิดปกติหรือไม่
   - เวลาผิดปกติ (เช่น 03:00)
   - IP Address ผิดปกติ

---

## FAQs / คำถามที่พบบ่อย

**❓ ลบ Audit Log ได้ไหม?**

**คำตอบ**: **ไม่ได้** (โดยทั่วไป)

**เหตุผล**: Audit Log เป็นหลักฐานสำคัญ ต้องเก็บไว้ตรวจสอบ

**ข้อยกเว้น**: เฉพาะ Super Admin อาจลบได้ (กรณีพิเศษ)

---

**❓ ใครสามารถดู Audit Log ได้?**

**คำตอบ**: **เฉพาะ Admin**

- Admin ดูได้ทุก Log
- Staff ไม่เห็น Audit Log

---

**❓ Audit Log บันทึกอะไรบ้าง?**

**คำตอบ**: ทุกการกระทำที่สำคัญ

**รายการ**:
- CREATED, ASSIGNED, REASSIGNED, STATUS_CHANGED, CANCELLED, UPDATED

---

**⬅️ ก่อนหน้า**: [47-Export-Data.md](47-Export-Data.md) | **➡️ ถัดไป**: [49-System-Settings.md](49-System-Settings.md)
